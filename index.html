<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Анализ выручки по городам</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background-color: white;
				padding: 20px;
				border-radius: 8px;
				box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			}
			h1 {
				color: #333;
				text-align: center;
			}
			.file-input-container {
				margin-bottom: 20px;
				padding: 15px;
				background-color: #f0f8ff;
				border-radius: 5px;
			}
			.controls {
				margin-bottom: 20px;
				display: flex;
				gap: 15px;
				align-items: center;
				flex-wrap: wrap;
			}
			select,
			button {
				padding: 8px 12px;
				border: 1px solid #ddd;
				border-radius: 4px;
				font-size: 14px;
			}
			button {
				background-color: #4caf50;
				color: white;
				cursor: pointer;
				transition: background-color 0.3s;
			}
			button:hover {
				background-color: #45a049;
			}
			button:disabled {
				background-color: #cccccc;
				cursor: not-allowed;
			}
			table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 20px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			}
			th,
			td {
				border: 1px solid #ddd;
				padding: 12px;
				text-align: left;
			}
			th {
				background-color: #2c5aa0;
				color: white;
				font-weight: bold;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}
			tr:nth-child(even) {
				background-color: #f8f9fa;
			}
			tr:hover {
				background-color: #e9ecef;
				transition: background-color 0.2s;
			}
			.stats {
				margin: 20px 0;
				padding: 15px;
				background-color: #f0f8ff;
				border-radius: 5px;
				font-size: 16px;
				font-weight: bold;
			}
			.chart-container {
				margin-top: 30px;
				height: 400px;
			}
			.error {
				color: red;
				margin-top: 10px;
				padding: 10px;
				background-color: #ffe6e6;
				border-radius: 4px;
			}
			.hidden {
				display: none;
			}
			#tableTitle {
				color: #2c5aa0;
				border-bottom: 2px solid #2c5aa0;
				padding-bottom: 10px;
			}

			/* Стили для toast-уведомлений */
			.toast-container {
				position: fixed;
				bottom: 20px;
				right: 20px;
				z-index: 1000;
				max-width: 500px;
			}

			.toast {
				background-color: #323232;
				color: white;
				padding: 16px;
				margin-top: 10px;
				border-radius: 8px;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
				animation: slideIn 0.3s ease-out;
				max-width: 500px;
			}

			.toast.error {
				background-color: #d32f2f;
			}

			.toast.warning {
				background-color: #f57c00;
			}

			.toast.success {
				background-color: #388e3c;
			}

			.toast.info {
				background-color: #1976d2;
			}

			.toast.fields {
				background-color: #7b1fa2;
			}

			.toast-close {
				background: none;
				border: none;
				color: white;
				font-size: 18px;
				cursor: pointer;
				margin-left: 10px;
				float: right;
			}

			.toast-content {
				flex: 1;
			}

			.toast-title {
				font-weight: bold;
				margin-bottom: 8px;
				font-size: 16px;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.fields-list {
				margin: 8px 0;
			}

			.field-item {
				padding: 6px 8px;
				margin: 4px 0;
				border-radius: 4px;
				display: flex;
				align-items: center;
			}

			.field-valid {
				background-color: rgba(76, 175, 80, 0.2);
				border-left: 3px solid #4caf50;
			}

			.field-invalid {
				background-color: rgba(244, 67, 54, 0.2);
				border-left: 3px solid #f44336;
			}

			.field-icon {
				margin-right: 8px;
				font-weight: bold;
			}

			@keyframes slideIn {
				from {
					transform: translateX(100%);
					opacity: 0;
				}
				to {
					transform: translateX(0);
					opacity: 1;
				}
			}

			/* Стили для блока качества данных */
			.quality-report {
				margin: 20px 0;
				padding: 15px;
				background-color: #fff8e1;
				border-radius: 5px;
				border-left: 4px solid #ffc107;
			}

			.quality-report h3 {
				margin-top: 0;
				color: #ff8f00;
			}

			.quality-stats {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 10px;
				margin: 10px 0;
			}

			.quality-stat {
				padding: 8px;
				background-color: #fff3cd;
				border-radius: 4px;
			}

			.field-validation {
				margin: 15px 0;
				padding: 15px;
				background-color: #e8f5e9;
				border-radius: 5px;
				border-left: 4px solid #4caf50;
			}

			.field-list {
				list-style-type: none;
				padding: 0;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Анализ выручки по городам (топ 10)</h1>

			<div class="file-input-container">
				<label for="csvFile">Выберите CSV файл:</label>
				<input type="file" id="csvFile" accept=".csv" />
				<span id="fileError" class="error hidden"></span>
			</div>

			<!-- Блок качества данных (для второго набора данных) -->
			<div id="dataQuality" class="quality-report hidden">
				<h3>Качество данных</h3>
				<div id="qualityStats" class="quality-stats"></div>
				<div id="validRowsInfo"></div>
			</div>

			<div class="controls">
				<label for="yearSelect">Выберите год:</label>
				<select id="yearSelect" disabled>
					<option value="">-- Выберите год --</option>
				</select>
				<button id="analyzeBtn" disabled>Анализировать</button>
			</div>

			<div id="results" class="hidden">
				<h2 id="tableTitle"></h2>
				<table id="resultsTable">
					<thead>
						<tr>
							<th>№</th>
							<th>Город</th>
							<th>Штат</th>
							<th>Выручка ($)</th>
							<th>Доля (%)</th>
						</tr>
					</thead>
					<tbody id="tableBody"></tbody>
				</table>

				<div class="stats">
					<p id="totalRevenue"></p>
					<p id="allYearsRevenue"></p>
					<p id="yearPercentage"></p>
				</div>

				<div class="chart-container">
					<canvas id="revenueChart"></canvas>
				</div>
			</div>
		</div>

		<!-- Контейнер для toast-уведомлений -->
		<div class="toast-container" id="toastContainer"></div>

		<script>
			// Элементы DOM
			const csvFileInput = document.getElementById('csvFile')
			const yearSelect = document.getElementById('yearSelect')
			const analyzeBtn = document.getElementById('analyzeBtn')
			const resultsDiv = document.getElementById('results')
			const tableTitle = document.getElementById('tableTitle')
			const tableBody = document.getElementById('tableBody')
			const totalRevenueEl = document.getElementById('totalRevenue')
			const allYearsRevenueEl = document.getElementById('allYearsRevenue')
			const yearPercentageEl = document.getElementById('yearPercentage')
			const fileError = document.getElementById('fileError')
			const dataQuality = document.getElementById('dataQuality')
			const qualityStats = document.getElementById('qualityStats')
			const validRowsInfo = document.getElementById('validRowsInfo')
			const toastContainer = document.getElementById('toastContainer')
			let revenueChart = null

			// Обязательные поля
			const requiredFields = [
				'name',
				'segment',
				'state',
				'city',
				'order_date',
				'ship_mode',
				'sales',
			]

			// Переменные для хранения данных
			let csvData = []
			let availableYears = []
			let dataQualityStats = {
				totalRows: 0,
				invalidDateRows: 0,
				missingValueRows: 0,
				outlierRows: 0,
				validRows: 0,
			}

			// Функция для показа toast-уведомлений
			function showToast(message, type = 'info', duration = 5000) {
				const toast = document.createElement('div')
				toast.className = `toast ${type}`

				toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-title">
                        <span>${message}</span>
                        <button class="toast-close">&times;</button>
                    </div>
                </div>
            `

				toastContainer.appendChild(toast)

				// Обработчик закрытия toast
				const closeBtn = toast.querySelector('.toast-close')
				closeBtn.addEventListener('click', () => {
					toast.remove()
				})

				// Автоматическое закрытие
				if (duration > 0) {
					setTimeout(() => {
						if (toast.parentNode) {
							toast.remove()
						}
					}, duration)
				}

				return toast
			}

			// Функция для показа информации о полях в формате toast
			function showFieldsToast(headers, missingColumns) {
				const presentFields = requiredFields.filter(field =>
					headers.includes(field)
				)

				const toast = document.createElement('div')
				toast.className = 'toast fields'

				let fieldsHTML = ''
				requiredFields.forEach(field => {
					const isValid = headers.includes(field)
					fieldsHTML += `
                    <div class="field-item ${
											isValid ? 'field-valid' : 'field-invalid'
										}">
                        <span class="field-icon">${isValid ? '✓' : '✗'}</span>
                        <span>${field} ${isValid ? '' : '(отсутствует)'}</span>
                    </div>
                `
				})

				toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-title">
                        <span>Информация о полях файла</span>
                        <button class="toast-close">&times;</button>
                    </div>
                    <div class="fields-list">
                        ${fieldsHTML}
                    </div>
                    <div style="margin-top: 8px; font-size: 14px; opacity: 0.9;">
                        Найдено: ${presentFields.length} из ${requiredFields.length} обязательных полей
                    </div>
                </div>
            `

				toastContainer.appendChild(toast)

				// Обработчик закрытия toast
				const closeBtn = toast.querySelector('.toast-close')
				closeBtn.addEventListener('click', () => {
					toast.remove()
				})

				// Этот toast не закрывается автоматически
				return toast
			}

			// Обработчик загрузки файла
			csvFileInput.addEventListener('change', function (e) {
				const file = e.target.files[0]

				// Сбрасываем UI
				resetUI()

				// Валидация файла
				if (!file) {
					return
				}

				if (!file.name.toLowerCase().endsWith('.csv')) {
					showError('Пожалуйста, выберите файл в формате CSV.')
					showToast('Пожалуйста, выберите файл в формате CSV.', 'error')
					return
				}

				fileError.classList.add('hidden')
				dataQuality.classList.add('hidden')

				// Чтение файла
				const reader = new FileReader()
				reader.onload = function (event) {
					try {
						const text = event.target.result
						parseCSV(text)
					} catch (error) {
						showError('Ошибка при чтении файла: ' + error.message)
						showToast('Ошибка при чтении файла: ' + error.message, 'error')
						resetUI()
					}
				}
				reader.onerror = function () {
					showError('Ошибка при чтении файла.')
					showToast('Ошибка при чтении файла.', 'error')
					resetUI()
				}
				reader.readAsText(file)
			})

			// Обработчик кнопки анализа
			analyzeBtn.addEventListener('click', function () {
				const selectedYear = yearSelect.value
				if (!selectedYear) {
					showToast('Пожалуйста, выберите год.', 'warning')
					return
				}

				analyzeData(selectedYear)
			})

			// Функция парсинга CSV с улучшенной валидацией
			function parseCSV(text) {
				const lines = text.split('\n').filter(line => line.trim() !== '')
				dataQualityStats = {
					totalRows: 0,
					invalidDateRows: 0,
					missingValueRows: 0,
					outlierRows: 0,
					validRows: 0,
				}

				// Валидация пустого файла
				if (lines.length === 0) {
					throw new Error('Файл пустой.')
				}

				// Валидация файла только с заголовками
				if (lines.length === 1) {
					throw new Error('Файл содержит только заголовки без данных.')
				}

				// Получаем заголовки
				const headers = lines[0].split(',').map(header => header.trim())

				// Проверяем наличие необходимых колонок
				const missingColumns = requiredFields.filter(
					col => !headers.includes(col)
				)

				// Для первого набора данных - проверяем поля и показываем отчет
				if (missingColumns.length > 0) {
					showFieldsToast(headers, missingColumns)
					throw new Error('CSV файл не содержит всех обязательных полей')
				}

				// Для второго набора данных - парсим с валидацией данных
				dataQualityStats.totalRows = lines.length - 1

				// Парсим данные с улучшенной валидацией
				csvData = []
				let errorCount = 0
				let warningCount = 0

				for (let i = 1; i < lines.length; i++) {
					const values = parseCSVLine(lines[i])
					if (values.length !== headers.length) {
						console.warn(
							`Строка ${
								i + 1
							} имеет неверное количество полей и будет пропущена.`
						)
						dataQualityStats.missingValueRows++
						errorCount++
						continue
					}

					const row = {}
					headers.forEach((header, index) => {
						row[header] = values[index].trim()
					})

					// Валидация обязательных полей
					const missingValues = requiredFields.filter(
						field => !row[field] || row[field] === ''
					)
					if (missingValues.length > 0) {
						dataQualityStats.missingValueRows++
						errorCount++
						continue
					}

					// Валидация продаж (число и положительное значение)
					const sales = parseFloat(row.sales)
					if (isNaN(sales)) {
						dataQualityStats.outlierRows++
						errorCount++
						continue
					}

					// Валидация отрицательных значений и выбросов
					let isOutlier = false
					if (sales < 0) {
						dataQualityStats.outlierRows++
						warningCount++
						isOutlier = true
					}

					// Валидация выбросов (слишком большие значения)
					if (sales > 1000000) {
						dataQualityStats.outlierRows++
						warningCount++
						isOutlier = true
					}

					// Пропускаем строки с выбросами
					if (isOutlier) {
						continue
					}

					// Валидация даты
					const dateParts = row.order_date.split('-')
					if (dateParts.length !== 3) {
						dataQualityStats.invalidDateRows++
						errorCount++
						continue
					}

					const year = parseInt(dateParts[0])
					const month = parseInt(dateParts[1])
					const day = parseInt(dateParts[2])

					if (
						isNaN(year) ||
						isNaN(month) ||
						isNaN(day) ||
						year < 2000 ||
						year > 2030 ||
						month < 1 ||
						month > 12 ||
						day < 1 ||
						day > 31
					) {
						dataQualityStats.invalidDateRows++
						errorCount++
						continue
					}

					row.year = year
					row.salesValue = sales

					csvData.push(row)
					dataQualityStats.validRows++
				}

				// Показываем отчет о качестве данных для второго набора
				showDataQualityReport()

				// Показываем уведомления о проблемах в данных
				if (errorCount > 0) {
					showToast(
						`Обнаружено ${errorCount} ошибок в данных. Некорректные строки пропущены.`,
						'warning',
						7000
					)
				}

				if (warningCount > 0) {
					showToast(
						`Обнаружено ${warningCount} предупреждений в данных. Проверьте корректность значений.`,
						'info',
						5000
					)
				}

				if (csvData.length === 0) {
					throw new Error('В файле нет корректных данных для анализа.')
				}

				console.log(`Успешно загружено ${csvData.length} строк данных.`)

				// Активируем интерфейс для анализа
				extractYears()
				populateYearSelect()
				analyzeBtn.disabled = false

				if (dataQualityStats.validRows === dataQualityStats.totalRows) {
					showToast('Данные успешно загружены и проверены', 'success')
				} else {
					showToast(
						'Данные загружены с предупреждениями. Некоторые строки были исключены.',
						'warning'
					)
				}
			}

			// Функция для показа отчета о качестве данных (второй набор данных)
			function showDataQualityReport() {
				qualityStats.innerHTML = `
                <div class="quality-stat">Всего строк в файле: ${dataQualityStats.totalRows}</div>
                <div class="quality-stat">Строк с некорректными датами: ${dataQualityStats.invalidDateRows}</div>
                <div class="quality-stat">Строк с пропущенными значениями: ${dataQualityStats.missingValueRows}</div>
                <div class="quality-stat">Строк с выбросами в продажах: ${dataQualityStats.outlierRows}</div>
            `

				validRowsInfo.innerHTML = `<strong>Валидных строк после очистки: ${dataQualityStats.validRows}</strong>`

				dataQuality.classList.remove('hidden')
			}

			// Функция для корректного парсинга строк CSV (учитывает кавычки)
			function parseCSVLine(line) {
				const result = []
				let current = ''
				let inQuotes = false

				for (let i = 0; i < line.length; i++) {
					const char = line[i]

					if (char === '"') {
						inQuotes = !inQuotes
					} else if (char === ',' && !inQuotes) {
						result.push(current)
						current = ''
					} else {
						current += char
					}
				}

				result.push(current)
				return result
			}

			// Извлечение доступных годов из данных
			function extractYears() {
				const yearsSet = new Set()
				csvData.forEach(row => {
					if (row.year && !isNaN(row.year)) {
						yearsSet.add(row.year)
					}
				})

				availableYears = Array.from(yearsSet).sort((a, b) => a - b)

				// Валидация набора данных только для одного года
				if (availableYears.length === 1) {
					showToast(
						`В данных представлен только ${availableYears[0]} год.`,
						'info'
					)
				}
			}

			// Заполнение выпадающего списка годов
			function populateYearSelect() {
				yearSelect.innerHTML = '<option value="">-- Выберите год --</option>'
				availableYears.forEach(year => {
					const option = document.createElement('option')
					option.value = year
					option.textContent = year
					yearSelect.appendChild(option)
				})
				yearSelect.disabled = false
			}

			// Анализ данных за выбранный год
			function analyzeData(year) {
				// Фильтруем данные по году
				const yearData = csvData.filter(row => row.year === parseInt(year))

				if (yearData.length === 0) {
					showToast(`Нет данных за ${year} год.`, 'error')
					return
				}

				// Группируем по городам и штатам
				const cityData = {}
				yearData.forEach(row => {
					const key = row.city + '|' + row.state
					if (!cityData[key]) {
						cityData[key] = {
							city: row.city,
							state: row.state,
							revenue: 0,
						}
					}
					cityData[key].revenue += row.salesValue
				})

				// Преобразуем в массив и сортируем по выручке
				const cityArray = Object.keys(cityData).map(key => ({
					city: cityData[key].city,
					state: cityData[key].state,
					revenue: cityData[key].revenue,
				}))

				cityArray.sort((a, b) => b.revenue - a.revenue)

				// Берем топ-10
				const top10 = cityArray.slice(0, 10)

				// Вычисляем общую выручку за год
				const totalRevenueYear = yearData.reduce(
					(sum, row) => sum + row.salesValue,
					0
				)

				// Вычисляем общую выручку за все года
				const totalRevenueAll = csvData.reduce(
					(sum, row) => sum + row.salesValue,
					0
				)

				// Вычисляем долю топ-10 городов и процент выручки за год
				const yearPercentage = (
					(totalRevenueYear / totalRevenueAll) *
					100
				).toFixed(2)

				// Для каждого города вычисляем долю в процентах от общей выручки за год
				top10.forEach(city => {
					city.percentage = ((city.revenue / totalRevenueYear) * 100).toFixed(2)
				})

				// Отображаем результаты
				displayResults(
					year,
					top10,
					totalRevenueYear,
					totalRevenueAll,
					yearPercentage
				)

				// Строим диаграмму
				buildChart(top10, year)

				showToast(`Анализ данных за ${year} год завершен`, 'success')
			}

			// Отображение результатов в таблице
			function displayResults(
				year,
				top10,
				totalRevenueYear,
				totalRevenueAll,
				yearPercentage
			) {
				// Обновляем заголовок
				tableTitle.textContent = `Выручка по городам за ${year} год (топ 10)`

				// Очищаем таблицу
				tableBody.innerHTML = ''

				// Заполняем таблицу
				top10.forEach((city, index) => {
					const row = document.createElement('tr')

					const numberCell = document.createElement('td')
					numberCell.textContent = index + 1

					const cityCell = document.createElement('td')
					cityCell.textContent = city.city

					const stateCell = document.createElement('td')
					stateCell.textContent = city.state

					const revenueCell = document.createElement('td')
					revenueCell.textContent = formatCurrency(city.revenue)

					const percentageCell = document.createElement('td')
					percentageCell.textContent = city.percentage + '%'

					row.appendChild(numberCell)
					row.appendChild(cityCell)
					row.appendChild(stateCell)
					row.appendChild(revenueCell)
					row.appendChild(percentageCell)

					tableBody.appendChild(row)
				})

				// Обновляем статистику
				totalRevenueEl.textContent = `Общая выручка за ${year} год: ${formatCurrency(
					totalRevenueYear
				)}`
				allYearsRevenueEl.textContent = `Общая выручка за все года: ${formatCurrency(
					totalRevenueAll
				)}`
				yearPercentageEl.textContent = `Процент выручки за ${year} год от общей: ${yearPercentage}%`

				// Показываем результаты
				resultsDiv.classList.remove('hidden')
			}

			// Форматирование валюты
			function formatCurrency(amount) {
				return '$' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')
			}

			// Построение диаграммы
			function buildChart(top10, year) {
				const ctx = document.getElementById('revenueChart').getContext('2d')

				// Уничтожаем предыдущую диаграмму, если она существует
				if (revenueChart) {
					revenueChart.destroy()
				}

				// Подготавливаем данные для диаграммы
				const labels = top10.map(city => `${city.city}, ${city.state}`)
				const data = top10.map(city => city.revenue)

				// Создаем диаграмму
				revenueChart = new Chart(ctx, {
					type: 'bar',
					data: {
						labels: labels,
						datasets: [
							{
								label: `Выручка по городам за ${year} год ($)`,
								data: data,
								backgroundColor: [
									'rgba(255, 99, 132, 0.7)',
									'rgba(54, 162, 235, 0.7)',
									'rgba(255, 206, 86, 0.7)',
									'rgba(75, 192, 192, 0.7)',
									'rgba(153, 102, 255, 0.7)',
									'rgba(255, 159, 64, 0.7)',
									'rgba(199, 199, 199, 0.7)',
									'rgba(83, 102, 255, 0.7)',
									'rgba(40, 159, 64, 0.7)',
									'rgba(210, 99, 132, 0.7)',
								],
								borderColor: [
									'rgba(255, 99, 132, 1)',
									'rgba(54, 162, 235, 1)',
									'rgba(255, 206, 86, 1)',
									'rgba(75, 192, 192, 1)',
									'rgba(153, 102, 255, 1)',
									'rgba(255, 159, 64, 1)',
									'rgba(199, 199, 199, 1)',
									'rgba(83, 102, 255, 1)',
									'rgba(40, 159, 64, 1)',
									'rgba(210, 99, 132, 1)',
								],
								borderWidth: 1,
							},
						],
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							y: {
								beginAtZero: true,
								title: {
									display: true,
									text: 'Выручка ($)',
								},
							},
							x: {
								title: {
									display: true,
									text: 'Города',
								},
							},
						},
						plugins: {
							legend: {
								display: false,
							},
							tooltip: {
								callbacks: {
									label: function (context) {
										return `Выручка: ${formatCurrency(context.raw)}`
									},
								},
							},
						},
					},
				})
			}

			// Показать ошибку
			function showError(message) {
				fileError.textContent = message
				fileError.classList.remove('hidden')
			}

			// Сброс интерфейса
			function resetUI() {
				csvData = []
				availableYears = []
				yearSelect.innerHTML = '<option value="">-- Выберите год --</option>'
				yearSelect.disabled = true
				analyzeBtn.disabled = true
				resultsDiv.classList.add('hidden')
				dataQuality.classList.add('hidden')

				if (revenueChart) {
					revenueChart.destroy()
					revenueChart = null
				}
			}
		</script>
	</body>
</html>
